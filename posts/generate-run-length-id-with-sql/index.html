<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Generate Run-Length ID With SQL | Ha's Learning Docs</title>
<meta name=keywords content="data,analytics,sql,tips,session"><meta name=description content="What is run-length ID? Sometimes during analysis work, you need to group consecutive sequence of values into different &ldquo;runs&rdquo;, and calculate metrics for each run. For example:
Given a time series recording some entity&rsquo;s state, you want to calculate on average, how long does an entity stay in a particular state. Or a more specific example: Given a series of event data of several users, you want to group the users&rsquo; events into sessions with a session cut-off threshold of your choice This technique is also called sessionization."><meta name=author content="Ha Pham"><link rel=canonical href=http://hoanghapham.github.io/posts/generate-run-length-id-with-sql/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.30d2332871da51f600f574811c17751e6c862577d450b624f86e2bc8a6e31221.js integrity="sha256-MNIzKHHaUfYA9XSBHBd1HmyGJXfUULYk+G4ryKbjEiE=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=http://hoanghapham.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://hoanghapham.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://hoanghapham.github.io/favicon-32x32.png><link rel=apple-touch-icon href=http://hoanghapham.github.io/apple-touch-icon.png><link rel=mask-icon href=http://hoanghapham.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.123.0"><link rel=alternate hreflang=en href=http://hoanghapham.github.io/posts/generate-run-length-id-with-sql/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Generate Run-Length ID With SQL"><meta property="og:description" content="What is run-length ID? Sometimes during analysis work, you need to group consecutive sequence of values into different &ldquo;runs&rdquo;, and calculate metrics for each run. For example:
Given a time series recording some entity&rsquo;s state, you want to calculate on average, how long does an entity stay in a particular state. Or a more specific example: Given a series of event data of several users, you want to group the users&rsquo; events into sessions with a session cut-off threshold of your choice This technique is also called sessionization."><meta property="og:type" content="article"><meta property="og:url" content="http://hoanghapham.github.io/posts/generate-run-length-id-with-sql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-07T20:42:18+07:00"><meta property="article:modified_time" content="2022-02-07T20:42:18+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Generate Run-Length ID With SQL"><meta name=twitter:description content="What is run-length ID? Sometimes during analysis work, you need to group consecutive sequence of values into different &ldquo;runs&rdquo;, and calculate metrics for each run. For example:
Given a time series recording some entity&rsquo;s state, you want to calculate on average, how long does an entity stay in a particular state. Or a more specific example: Given a series of event data of several users, you want to group the users&rsquo; events into sessions with a session cut-off threshold of your choice This technique is also called sessionization."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://hoanghapham.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Generate Run-Length ID With SQL","item":"http://hoanghapham.github.io/posts/generate-run-length-id-with-sql/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Generate Run-Length ID With SQL","name":"Generate Run-Length ID With SQL","description":"What is run-length ID? Sometimes during analysis work, you need to group consecutive sequence of values into different \u0026ldquo;runs\u0026rdquo;, and calculate metrics for each run. For example:\nGiven a time series recording some entity\u0026rsquo;s state, you want to calculate on average, how long does an entity stay in a particular state. Or a more specific example: Given a series of event data of several users, you want to group the users\u0026rsquo; events into sessions with a session cut-off threshold of your choice This technique is also called sessionization.","keywords":["data","analytics","sql","tips","session"],"articleBody":"What is run-length ID? Sometimes during analysis work, you need to group consecutive sequence of values into different “runs”, and calculate metrics for each run. For example:\nGiven a time series recording some entity’s state, you want to calculate on average, how long does an entity stay in a particular state. Or a more specific example: Given a series of event data of several users, you want to group the users’ events into sessions with a session cut-off threshold of your choice This technique is also called sessionization.\nGenerate run-length ID with R If you are an R user, you may have heard of this kind of analysis. This operation is made trivial with the data.table package, since its rleid/rleidv function can directly generate run-length IDs that are incremented when a new run is commenced.\nSince I work most of the time with SQL, sometimes I need to have this kind of behavior in my SQL code. After some experiments, I finally figured out a way to do it. Here’s how:\nFirst, indexing all the rows in the dataset Next, figure out the “points” where the state of your entity changes from one to another by comparing current row and a previous row. ID these “switch points”. Use the switch points’ IDs as the ID of the consecutive runs In this post I will use BigQuery’s Standard SQL to demonstrate how this work, but you can easily implement this in other SQL flavors, as long as your SQL support analytical functions (LEAD, LAG, ROW_NUMBER, FIRST_VALUE, LAST_VALUE…)\nGenerate run-length ID with SQL Example: How long does an object stay in a state? Suppose we have a device with two state (active/inactive) and we periodically record the state of the device at a particular time. We want to calculate how long do they typically stay in a certain state\n1. Index all rows, and get the previous state The first step is to create a column containing the previous state, and a “row index” column. We will use the previous_state field to determine the point where the device switch to a new state, and use the idx field to generate the run-length ID.\nSince we have multiple devices, we have to partition by device_id when using lag() to make sure we do not get the state of a device into data of another device.\nselect * , lag(state, 1) over (partition by device_id order by timestamp) as previous_state , row_number() over (order by timestamp) as idx from test.consecutive_runs order by device_id, timestamp 2. Determine the state switching points Next, we will check for the “switch point”. If an event is a switch point, we will make the idx of that event NULL. This is to prepare for the generation of run-length ID.\nwith base as ( select * , lag(state, 1) over (partition by device_id order by timestamp) as previous_state , row_number() over (order by timestamp) as idx from test.consecutive_runs order by device_id, timestamp ) select * , case when previous_state is null or state != previous_state then idx else null end as switch_points from base As you can see, row 1 (start of the event series), row 3, row 7 and row 11 are marked as the “switch points”.\n3. Filling in the NULLs Next we can use the IDs at these switch points to fill the NULL rows below, up to the next switch point. This forward-filling feature can be achieved by BigQuery’s last_value() function:\nwith base as ( select * , lag(state, 1) over (partition by device_id order by timestamp) as previous_state , row_number() over (order by timestamp) as idx from test.consecutive_runs order by device_id, timestamp ) , switching as ( select * , case when previous_state is null or state != previous_state then idx else null end as switch_points from base ) select * , last_value(switch_points ignore nulls) over (order by timestamp) as run_length_id from switching So that’s how we have our run-length IDs. Now we can check on average how long each run lasts:\n... , aggr as ( select device_id , run_length_id , timestamp_diff(max(timestamp), min(timestamp), second) / 60 as session_duration from run_length_table group by 1, 2 ) select device_id , avg(session_duration) as average_session_duration from aggr group by 1 4. Another way to generate run-length IDs In step 2 and 3 above, we made use of NULLs and BigQuery’s last_value() function to generate the IDs. There is another way to generate these IDs using 1, 0 and a moving sum().\nInstead of marking “switch points” using idx and set the following row values to NULL, we can mark the switch point using value 1, and set the following rows to 0:\nwith base as ( select * , lag(state, 1) over (partition by device_id order by timestamp) as previous_state from test.consecutive_runs order by device_id, timestamp ) select * , case when previous_state is null or state != previous_state then 1 else 0 end as switch_points from base Then, use sum(...) over (partition by ...) to perform a running sum of switch points. Whenever the run hits a 1 value, the ID will be increased by one and will stay the same for the next rows (because the next rows are all 0).\nwith base as ( select * , lag(state, 1) over (partition by device_id order by timestamp) as previous_state from test.consecutive_runs order by device_id, timestamp ) , switching as ( select * , case when previous_state is null or state != previous_state then 1 else 0 end as switch_points from base ) select * , sum(switch_points) over (partition by device_id order by timestamp) as run_length_id from switching Final result: Practical use cases for sessionization This technique can have multiple applications, for example:\nYou have records user traffics on your website, but you are not happy with your tracker’s default session grouping. You may want to generate the sessions with your own logic. Your have a complex web application, and you have a specific workflow that you want users to go through. You may want to group user’s actions into workflows, and check the ratio of finished over unfinished flows. Hope that this simple tutorial can give you ideas to solve these kinds of problem.\n","wordCount":"1028","inLanguage":"en","datePublished":"2022-02-07T20:42:18+07:00","dateModified":"2022-02-07T20:42:18+07:00","author":{"@type":"Person","name":"Ha Pham"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://hoanghapham.github.io/posts/generate-run-length-id-with-sql/"},"publisher":{"@type":"Organization","name":"Ha's Learning Docs","logo":{"@type":"ImageObject","url":"http://hoanghapham.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://hoanghapham.github.io/ accesskey=h title="Ha's Learning Docs (Alt + H)">Ha's Learning Docs</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></span></div><ul id=menu><li><a href=http://hoanghapham.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=http://hoanghapham.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=http://hoanghapham.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=http://hoanghapham.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://hoanghapham.github.io/>Home</a>&nbsp;»&nbsp;<a href=http://hoanghapham.github.io/posts/>Posts</a></div><h1 class=post-title>Generate Run-Length ID With SQL</h1><div class=post-meta>&lt;span title='2022-02-07 20:42:18 +0700 +0700'>February 7, 2022&lt;/span>&amp;nbsp;·&amp;nbsp;5 min&amp;nbsp;·&amp;nbsp;Ha Pham</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#what-is-run-length-id aria-label="What is run-length ID?">What is run-length ID?</a></li><li><a href=#generate-run-length-id-with-r aria-label="Generate run-length ID with R">Generate run-length ID with R</a></li><li><a href=#generate-run-length-id-with-sql aria-label="Generate run-length ID with SQL">Generate run-length ID with SQL</a><ul><li><a href=#example-how-long-does-an-object-stay-in-a-state aria-label="Example: How long does an object stay in a state?">Example: How long does an object stay in a state?</a><ul><li><a href=#1-index-all-rows-and-get-the-previous-state aria-label="1. Index all rows, and get the previous state">1. Index all rows, and get the previous state</a></li><li><a href=#2-determine-the-state-switching-points aria-label="2. Determine the state switching points">2. Determine the state switching points</a></li><li><a href=#3-filling-in-the-nulls aria-label="3. Filling in the NULLs">3. Filling in the NULLs</a></li><li><a href=#4-another-way-to-generate-run-length-ids aria-label="4. Another way to generate run-length IDs">4. Another way to generate run-length IDs</a></li></ul></li></ul></li><li><a href=#practical-use-cases-for-sessionization aria-label="Practical use cases for sessionization">Practical use cases for sessionization</a></li></ul></div></details></div><div class=post-content><h1 id=what-is-run-length-id>What is run-length ID?<a hidden class=anchor aria-hidden=true href=#what-is-run-length-id>#</a></h1><p>Sometimes during analysis work, you need to group <strong>consecutive sequence of values</strong> into different &ldquo;runs&rdquo;, and calculate metrics for each run. For example:</p><ul><li><p>Given a time series recording some entity&rsquo;s state, you want to calculate on average, how long does an entity stay in a particular state.
<img loading=lazy src=/generate-run-length-id-with-sql/consecutive_runs.png alt></p></li><li><p>Or a more specific example: Given a series of event data of several users, you want to group the users&rsquo; events into sessions with a session cut-off threshold of your choice
<img loading=lazy src=/generate-run-length-id-with-sql/user_events.png alt></p></li></ul><p>This technique is also called <strong>sessionization</strong>.</p><h1 id=generate-run-length-id-with-r>Generate run-length ID with R<a hidden class=anchor aria-hidden=true href=#generate-run-length-id-with-r>#</a></h1><p>If you are an R user, you may have heard of this kind of analysis. This operation is made trivial with the <code>data.table</code> package, since its <code>rleid</code>/<code>rleidv</code> function can directly generate <strong>run-length IDs</strong> that are incremented when a new run is commenced.</p><p><img loading=lazy src=/generate-run-length-id-with-sql/rleidv.png alt></p><p>Since I work most of the time with SQL, sometimes I need to have this kind of behavior in my SQL code. After some experiments, I finally figured out a way to do it. Here&rsquo;s how:</p><ol><li>First, indexing all the rows in the dataset</li><li>Next, figure out the &ldquo;points&rdquo; where the state of your entity changes from one to another by comparing current row and a previous row. ID these &ldquo;switch points&rdquo;.</li><li>Use the switch points&rsquo; IDs as the ID of the consecutive runs</li></ol><p>In this post I will use BigQuery&rsquo;s Standard SQL to demonstrate how this work, but you can easily implement this in other SQL flavors, as long as your SQL support analytical functions (LEAD, LAG, ROW_NUMBER, FIRST_VALUE, LAST_VALUE&mldr;)</p><h1 id=generate-run-length-id-with-sql>Generate run-length ID with SQL<a hidden class=anchor aria-hidden=true href=#generate-run-length-id-with-sql>#</a></h1><h2 id=example-how-long-does-an-object-stay-in-a-state>Example: How long does an object stay in a state?<a hidden class=anchor aria-hidden=true href=#example-how-long-does-an-object-stay-in-a-state>#</a></h2><p>Suppose we have a device with two state (active/inactive) and we periodically record the state of the device at a particular time. We want to calculate how long do they typically stay in a certain state</p><h3 id=1-index-all-rows-and-get-the-previous-state>1. Index all rows, and get the previous state<a hidden class=anchor aria-hidden=true href=#1-index-all-rows-and-get-the-previous-state>#</a></h3><p>The first step is to create a column containing the previous state, and a &ldquo;row index&rdquo; column. We will use the <code>previous_state</code> field to determine the point where the device switch to a new state, and use the <code>idx</code> field to generate the run-length ID.</p><p>Since we have multiple devices, we have to <code>partition by device_id</code> when using <code>lag()</code> to make sure we do not get the state of a device into data of another device.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>  , lag(<span style=color:#66d9ef>state</span>, <span style=color:#ae81ff>1</span>) over (partition <span style=color:#66d9ef>by</span> device_id <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> previous_state
</span></span><span style=display:flex><span>  , row_number() over (<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> idx
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> test.consecutive_runs
</span></span><span style=display:flex><span><span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> device_id, <span style=color:#66d9ef>timestamp</span>
</span></span></code></pre></div><p><img loading=lazy src=/generate-run-length-id-with-sql/ex1-01.png alt></p><h3 id=2-determine-the-state-switching-points>2. Determine the state switching points<a hidden class=anchor aria-hidden=true href=#2-determine-the-state-switching-points>#</a></h3><p>Next, we will check for the &ldquo;switch point&rdquo;. If an event is a switch point, we will make the <code>idx</code> of that event NULL. This is to prepare for the generation of run-length ID.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> base <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    , lag(<span style=color:#66d9ef>state</span>, <span style=color:#ae81ff>1</span>) over (partition <span style=color:#66d9ef>by</span> device_id <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> previous_state
</span></span><span style=display:flex><span>    , row_number() over (<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> idx
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> test.consecutive_runs
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> device_id, <span style=color:#66d9ef>timestamp</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>  , <span style=color:#66d9ef>case</span> 
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>when</span> previous_state <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>state</span> <span style=color:#f92672>!=</span> previous_state 
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>then</span> idx 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>as</span> switch_points
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> base
</span></span></code></pre></div><p><img loading=lazy src=/generate-run-length-id-with-sql/ex1-02.png alt></p><p>As you can see, row 1 (start of the event series), row 3, row 7 and row 11 are marked as the &ldquo;switch points&rdquo;.</p><h3 id=3-filling-in-the-nulls>3. Filling in the NULLs<a hidden class=anchor aria-hidden=true href=#3-filling-in-the-nulls>#</a></h3><p>Next we can use the IDs at these switch points to fill the NULL rows below, up to the next switch point. This forward-filling feature can be achieved by BigQuery&rsquo;s <code>last_value()</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> base <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    , lag(<span style=color:#66d9ef>state</span>, <span style=color:#ae81ff>1</span>) over (partition <span style=color:#66d9ef>by</span> device_id <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> previous_state
</span></span><span style=display:flex><span>    , row_number() over (<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> idx
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> test.consecutive_runs
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> device_id, <span style=color:#66d9ef>timestamp</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>, switching <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    , <span style=color:#66d9ef>case</span> 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>when</span> previous_state <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>state</span> <span style=color:#f92672>!=</span> previous_state 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>then</span> idx 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>as</span> switch_points
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> base
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> 
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>  , last_value(switch_points <span style=color:#66d9ef>ignore</span> nulls) over (<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> run_length_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> switching
</span></span></code></pre></div><p><img loading=lazy src=/generate-run-length-id-with-sql/ex1-03.png alt>
<img loading=lazy src=/generate-run-length-id-with-sql/ex1-04.png alt></p><p>So that&rsquo;s how we have our run-length IDs. Now we can check on average how long each run lasts:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>, aggr <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span> 
</span></span><span style=display:flex><span>    device_id
</span></span><span style=display:flex><span>    , run_length_id
</span></span><span style=display:flex><span>    , timestamp_diff(<span style=color:#66d9ef>max</span>(<span style=color:#66d9ef>timestamp</span>), <span style=color:#66d9ef>min</span>(<span style=color:#66d9ef>timestamp</span>), <span style=color:#66d9ef>second</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>60</span> <span style=color:#66d9ef>as</span> session_duration
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> run_length_table
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> 
</span></span><span style=display:flex><span>  device_id
</span></span><span style=display:flex><span>  , <span style=color:#66d9ef>avg</span>(session_duration) <span style=color:#66d9ef>as</span> average_session_duration
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> aggr
</span></span><span style=display:flex><span><span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p><img loading=lazy src=/generate-run-length-id-with-sql/ex1-05.png alt></p><h3 id=4-another-way-to-generate-run-length-ids>4. Another way to generate run-length IDs<a hidden class=anchor aria-hidden=true href=#4-another-way-to-generate-run-length-ids>#</a></h3><p>In step 2 and 3 above, we made use of NULLs and BigQuery&rsquo;s <code>last_value()</code> function to generate the IDs. There is another way to generate these IDs using 1, 0 and a moving <code>sum()</code>.</p><p>Instead of marking &ldquo;switch points&rdquo; using <code>idx</code> and set the following row values to NULL, we can mark the switch point using value <code>1</code>, and set the following rows to 0:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> base <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    , lag(<span style=color:#66d9ef>state</span>, <span style=color:#ae81ff>1</span>) over (partition <span style=color:#66d9ef>by</span> device_id <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> previous_state
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> test.consecutive_runs
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> device_id, <span style=color:#66d9ef>timestamp</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>  , <span style=color:#66d9ef>case</span> 
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>when</span> previous_state <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>state</span> <span style=color:#f92672>!=</span> previous_state 
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>as</span> switch_points
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> base
</span></span></code></pre></div><p><img loading=lazy src=/generate-run-length-id-with-sql/ex2-01.png alt></p><p>Then, use <code>sum(...) over (partition by ...)</code> to perform a running sum of switch points. Whenever the run hits a <code>1</code> value, the ID will be increased by one and will stay the same for the next rows (because the next rows are all <code>0</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> base <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    , lag(<span style=color:#66d9ef>state</span>, <span style=color:#ae81ff>1</span>) over (partition <span style=color:#66d9ef>by</span> device_id <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> previous_state
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> test.consecutive_runs
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> device_id, <span style=color:#66d9ef>timestamp</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>, switching <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    , <span style=color:#66d9ef>case</span> 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>when</span> previous_state <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>state</span> <span style=color:#f92672>!=</span> previous_state 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>as</span> switch_points
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> base
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>  , <span style=color:#66d9ef>sum</span>(switch_points) over (partition <span style=color:#66d9ef>by</span> device_id <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>as</span> run_length_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> switching
</span></span></code></pre></div><p>Final result:
<img loading=lazy src=/generate-run-length-id-with-sql/ex2-02.png alt></p><h1 id=practical-use-cases-for-sessionization>Practical use cases for sessionization<a hidden class=anchor aria-hidden=true href=#practical-use-cases-for-sessionization>#</a></h1><p>This technique can have multiple applications, for example:</p><ul><li>You have records user traffics on your website, but you are not happy with your tracker&rsquo;s default session grouping. You may want to generate the sessions with your own logic.</li><li>Your have a complex web application, and you have a specific workflow that you want users to go through. You may want to group user&rsquo;s actions into workflows, and check the ratio of finished over unfinished flows.</li></ul><p>Hope that this simple tutorial can give you ideas to solve these kinds of problem.</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://hoanghapham.github.io/tags/data/>Data</a></li><li><a href=http://hoanghapham.github.io/tags/analytics/>Analytics</a></li><li><a href=http://hoanghapham.github.io/tags/sql/>Sql</a></li><li><a href=http://hoanghapham.github.io/tags/tips/>Tips</a></li><li><a href=http://hoanghapham.github.io/tags/session/>Session</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Generate Run-Length ID With SQL on twitter" href="https://twitter.com/intent/tweet/?text=Generate%20Run-Length%20ID%20With%20SQL&amp;url=http%3a%2f%2fhoanghapham.github.io%2fposts%2fgenerate-run-length-id-with-sql%2f&amp;hashtags=data%2canalytics%2csql%2ctips%2csession"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Run-Length ID With SQL on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2fhoanghapham.github.io%2fposts%2fgenerate-run-length-id-with-sql%2f&amp;title=Generate%20Run-Length%20ID%20With%20SQL&amp;summary=Generate%20Run-Length%20ID%20With%20SQL&amp;source=http%3a%2f%2fhoanghapham.github.io%2fposts%2fgenerate-run-length-id-with-sql%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Run-Length ID With SQL on reddit" href="https://reddit.com/submit?url=http%3a%2f%2fhoanghapham.github.io%2fposts%2fgenerate-run-length-id-with-sql%2f&title=Generate%20Run-Length%20ID%20With%20SQL"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Run-Length ID With SQL on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fhoanghapham.github.io%2fposts%2fgenerate-run-length-id-with-sql%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Run-Length ID With SQL on whatsapp" href="https://api.whatsapp.com/send?text=Generate%20Run-Length%20ID%20With%20SQL%20-%20http%3a%2f%2fhoanghapham.github.io%2fposts%2fgenerate-run-length-id-with-sql%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Run-Length ID With SQL on telegram" href="https://telegram.me/share/url?text=Generate%20Run-Length%20ID%20With%20SQL&amp;url=http%3a%2f%2fhoanghapham.github.io%2fposts%2fgenerate-run-length-id-with-sql%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://hoanghapham.github.io/>Ha's Learning Docs</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>